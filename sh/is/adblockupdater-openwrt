#!/bin/sh

# Adblock script for OpenWRT
# (c) 2014 by Jan Holthuis
#
# http://homepage.ruhr-uni-bochum.de/Jan.Holthuis/misc/adblock-on-your-openwrt-router/
# https://gist.github.com/OnlyInAmerica/75e200886e02e7562fa1

# This is an adblocker script for OpenWRT. Simply run this script as a
# daily cronjob on your OpenWRT-router. This works since OpenWRT
# revision 39312 [1] and does not manipulate any files in /etc/.
# Instead, this adds the adblock serverlist as a separate file
# to /tmp/dnsmasq.d/.

# [1] See https://dev.openwrt.org/changeset/39312/

# cronjob
# 0 0 */1 * * /usr/bin/adblockupdater.sh

tmpfile="$(mktemp -tu)"
dstfile="/tmp/dnsmasq.d/adblock.conf"

mkdir "/tmp/dnsmasq.d/" 2>/dev/null
echo "Getting yoyo ad list..." # Approximately 2452 domains at the time of writing
wget -q -O- "http://pgl.yoyo.org/adservers/serverlist.php?hostformat=unixhosts&showintro=0&mimetype=plaintext" > "${tmpfile}"
echo "Getting winhelp2002 ad list..." # 12985 domains
wget -q -O- "http://winhelp2002.mvps.org/hosts.txt" | grep -v "#" | \
    grep -v "127.0.0.1" | sed '/^$/d' | sed 's/\ /\\ /g' | \
    awk '{print $2}' >> "${tmpfile}"
echo "Getting adaway ad list..." # 445 domains
wget -q -O- "http://adaway.org/hosts.txt"| grep -v "#" | grep -v "::1"  | \
    sed '/^$/d' | sed 's/\ /\\ /g' | awk '{print $2}' | grep -v '^\\'   | \
    grep -v '\\$' >> "${tmpfile}"
echo "Getting hosts-file ad list..." # 28050 domains
wget -q -O- "http://hosts-file.net/.%5Cad_servers.txt" | grep -v "#"  | \
    grep -v "::1" | sed '/^$/d' | sed 's/\ /\\ /g' | awk '{print $2}' | \
    grep -v '^\\' | grep -v '\\$' >> "${tmpfile}"
echo "Getting malwaredomainlist ad list..." # 1352 domains
wget -q -O- "http://www.malwaredomainlist.com/hostslist/hosts.txt"  | \
    grep -v "#" | sed '/^$/d' | sed 's/\ /\\ /g' | awk '{print $3}' | \
    grep -v '^\\' | grep -v '\\$' >> "${tmpfile}"
echo "Getting adblock.gjtech ad list..." # 696 domains
wget -q -O- "http://adblock.gjtech.net/?format=unix-hosts" | grep -v "#" | \
    sed '/^$/d' | sed 's/\ /\\ /g' | awk '{print $2}' | grep -v '^\\'    | \
    grep -v '\\$' >> "${tmpfile}"
echo "Getting someone who cares ad list..." # 10600
wget -q -O- "http://someonewhocares.org/hosts/hosts" | grep -v "#" | \
    sed '/^$/d' | sed 's/\ /\\ /g' | grep -v '^\\' | grep -v '\\$' | \
    awk '{print $2}' | grep -v '^\\' | grep -v '\\$' >> "${tmpfile}"

#remove carriage returns, and empty lines
awk 'NF > 0 {gsub("\r$", ""); print }' "${tmpfile}"   > "${dstfile}"

# Write the destination file header
echo "# ${dstfile}: adblock server list for dnsmasq"  > "${tmpfile}"
echo "#" >> "${tmpfile}"
echo "# Autogenerated by /usr/bin/adblockupdater.sh" >> "${tmpfile}"
echo "# Last updated: $(date)" >> "${tmpfile}"
echo "" >> "${tmpfile}"

# Sort the aggregated results and remove any duplicates
# Remove entries from the whitelist file if it exists at the root of the current user's home folder
#echo "Removing duplicates and formatting the list of domains..."
cat "${dstfile}" | sort | uniq | awk '{print "address=/" $0 "/127.0.0.1"}' >> "${tmpfile}"
mv  "${tmpfile}" "${dstfile}"

printf "%s\\n" "$(awk 'END {print NR}' "${dstfile}") ad domains blocked."
echo "Everything fine, restarting dnsmasq to implement new serverlist..."
/etc/init.d/dnsmasq restart
